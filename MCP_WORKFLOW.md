# MCP to MyApp Workflow Guide

## üìã Overview

This guide explains how to add/update products using the MCP server (Claude Desktop) and deploy them to MyApp on Vercel.

### The Problem

When you add products via MCP locally:
1. ‚úÖ Products are added to `prisma/dev.db` (database)
2. ‚úÖ MCP generates `dist/bundle.json.gz`
3. ‚ùå **BUT** `myapp/public/bundle.json.gz` is NOT automatically updated
4. ‚ùå MyApp's `/api/bundle` endpoint serves the OLD bundle
5. ‚ùå Your new products don't appear in MyApp after sync

### The Solution

Use the **`sync-bundle.sh`** script to automatically:
- Generate bundle from database
- Copy to MyApp directory
- Optionally commit and push to GitHub
- Deploy to Vercel

---

## üöÄ Quick Start

### Option 1: Automated Script (Recommended)

```bash
# After adding products via MCP in Claude Desktop
./sync-bundle.sh
```

The script will:
1. Build bundle from `prisma/dev.db`
2. Copy to `myapp/public/bundle.json.gz`
3. Show bundle contents
4. Prompt to commit changes
5. Prompt to push to GitHub

### Option 2: Manual Steps

```bash
# 1. Generate bundle from database
cd mcp-server
node build-bundle-direct.js
cd ..

# 2. Copy bundle to MyApp
cp dist/bundle.json.gz myapp/public/bundle.json.gz

# 3. Verify contents
gunzip -c myapp/public/bundle.json.gz | jq '.products[].texts[] | select(.language == "ja") | .name'

# 4. Commit changes
git add myapp/public/bundle.json.gz dist/bundle.json.gz prisma/dev.db data/meta.json
git commit -m "chore: Update bundle with latest products"

# 5. Push to GitHub
git push

# 6. Deploy to Vercel (if not auto-deployed)
cd myapp
vercel --prod
```

---

## üìù Complete Workflow

### Step 1: Add Products via MCP (Claude Desktop)

**Using Claude Desktop with MCP server:**

1. Open Claude Desktop
2. Make sure MCP server is configured (check `claude_desktop_config.json`)
3. Use MCP tools to add products:

```
You: "Add a new product to the database:
- Name: Êñ∞„Åó„ÅÑË£ΩÂìÅ
- Category: health
- Points: 100
- Description: ..."

Claude: [Uses MCP tool to add product to database]
```

**Result:** Product added to `prisma/dev.db`

### Step 2: Sync Bundle to MyApp

**Option A: Using the script (Easy)**

```bash
./sync-bundle.sh
```

Follow the prompts:
- Commit? ‚Üí `y`
- Push? ‚Üí `y`

**Option B: Manual (if script fails)**

```bash
cd mcp-server
node build-bundle-direct.js
cd ..
cp dist/bundle.json.gz myapp/public/bundle.json.gz
```

### Step 3: Deploy to Vercel

**Option A: Auto-deploy (if GitHub connected)**

Vercel automatically deploys when you push to GitHub. Wait 1-2 minutes.

**Option B: Manual deploy**

```bash
cd myapp
vercel --prod
```

### Step 4: Test in MyApp

1. Open MyApp in browser
2. Go to Settings ‚Üí Clear All Data (or clear IndexedDB manually)
3. Go to Home ‚Üí Click "Sync Now"
4. Your new products should appear!

---

## üîß Troubleshooting

### Issue: Products don't appear after sync

**Cause:** Browser cache or IndexedDB has old data

**Solution:**
```bash
# In browser:
1. Press F12 ‚Üí Application tab
2. Delete IndexedDB ‚Üí MyAppDB
3. Clear Local Storage and Session Storage
4. Hard refresh: Ctrl+Shift+R
5. Click "Sync Now"
```

### Issue: Bundle shows 0 products

**Cause:** Database is empty or not initialized

**Solution:**
```bash
# Check database
node check-db.mjs

# If empty, add products
node add-real-products.mjs

# Then sync
./sync-bundle.sh
```

### Issue: Script fails with "command not found: jq"

**Cause:** `jq` is not installed

**Solution:**
```bash
# Install jq
# Ubuntu/Debian:
sudo apt-get install jq

# macOS:
brew install jq

# Or skip script, use manual steps
```

### Issue: Vercel shows old products

**Cause:** Deployment hasn't updated or bundle not in git

**Solution:**
```bash
# Check bundle is committed
git log --oneline -1 myapp/public/bundle.json.gz

# If not, commit and push
git add myapp/public/bundle.json.gz
git commit -m "chore: Update bundle"
git push

# Force redeploy
cd myapp
vercel --prod --force
```

---

## üìä Understanding the Data Flow

### Local Development

```
Claude Desktop (MCP)
  ‚Üì Add product
prisma/dev.db (SQLite database)
  ‚Üì node build-bundle-direct.js
dist/bundle.json.gz (Generated bundle)
  ‚Üì cp dist/bundle.json.gz myapp/public/
myapp/public/bundle.json.gz (MyApp bundle)
  ‚Üì git commit & push
GitHub Repository
  ‚Üì Vercel auto-deploy
Vercel Production
  ‚Üì User clicks "Sync Now"
MyApp IndexedDB
```

### Key Files

| File | Purpose | Updated By |
|------|---------|------------|
| `prisma/dev.db` | Source of truth | MCP tools, migration scripts |
| `dist/bundle.json.gz` | Generated bundle | `build-bundle-direct.js` |
| `myapp/public/bundle.json.gz` | MyApp bundle | Manual copy or script |
| `data/meta.json` | Bundle metadata | `build-bundle-direct.js` |

### Why Two Bundles?

**`dist/bundle.json.gz`:**
- Generated by MCP server
- Used by GitHub Actions (future)
- Can be published to GitHub Pages

**`myapp/public/bundle.json.gz`:**
- Served by Vercel `/api/bundle` endpoint
- What MyApp actually syncs
- Must be manually updated

---

## üéØ Best Practices

### 1. Always Use the Script

```bash
# ‚úÖ Good
./sync-bundle.sh

# ‚ùå Bad (easy to forget steps)
cd mcp-server && node build-bundle-direct.js && cd .. && cp dist/bundle.json.gz myapp/public/
```

### 2. Verify Bundle Before Committing

```bash
# Check product count
gunzip -c myapp/public/bundle.json.gz | jq '.productCount'

# Check product names
gunzip -c myapp/public/bundle.json.gz | jq '.products[].texts[] | select(.language == "ja") | .name'
```

### 3. Clear Browser Cache After Deploy

Always clear IndexedDB after deploying new bundle:
```
F12 ‚Üí Application ‚Üí IndexedDB ‚Üí Delete MyAppDB ‚Üí Sync Now
```

### 4. Test Locally Before Deploying

```bash
# Build MyApp
cd myapp
npm run build

# Run locally
npm start

# Test sync at http://localhost:3000
```

### 5. Commit Database Changes

Don't forget to commit `prisma/dev.db`:
```bash
git add prisma/dev.db
git commit -m "feat: Add new products to database"
```

---

## üîÑ Automated Workflow (Future)

### GitHub Actions (Future Enhancement)

Create `.github/workflows/sync-bundle.yml`:

```yaml
name: Sync Bundle

on:
  push:
    paths:
      - 'prisma/dev.db'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: cd mcp-server && node build-bundle-direct.js
      - run: cp dist/bundle.json.gz myapp/public/bundle.json.gz
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'chore: Auto-sync bundle from database'
```

This would automatically:
1. Detect database changes
2. Regenerate bundle
3. Copy to MyApp
4. Commit changes
5. Trigger Vercel deployment

---

## üìö Related Documentation

- **CLEAR_CACHE_INSTRUCTIONS.md** - How to clear browser cache
- **READY_TO_DEPLOY.md** - Deployment guide
- **VERCEL_DEPLOYMENT.md** - Vercel-specific instructions
- **PRD.md** - Product requirements

---

## üí° Tips

### Tip 1: Create Git Alias

Add to `.git/config` or `~/.gitconfig`:

```bash
[alias]
  sync-bundle = !./sync-bundle.sh
```

Then use: `git sync-bundle`

### Tip 2: Use npm Script

Add to root `package.json`:

```json
{
  "scripts": {
    "sync-bundle": "./sync-bundle.sh"
  }
}
```

Then use: `npm run sync-bundle`

### Tip 3: Watch for Changes

```bash
# Install nodemon
npm install -g nodemon

# Watch database and auto-sync
nodemon --watch prisma/dev.db --exec './sync-bundle.sh'
```

### Tip 4: Verify in Production

After deploying, verify bundle endpoint:

```bash
# Download production bundle
curl https://your-app.vercel.app/api/bundle -o prod-bundle.json.gz

# Check contents
gunzip -c prod-bundle.json.gz | jq '.productCount'
```

---

## ‚úÖ Checklist

Use this checklist every time you add products:

- [ ] Add products via MCP in Claude Desktop
- [ ] Run `./sync-bundle.sh`
- [ ] Verify bundle contents (products show up)
- [ ] Commit changes (script prompts)
- [ ] Push to GitHub (script prompts)
- [ ] Wait for Vercel deployment (1-2 min)
- [ ] Open MyApp in browser
- [ ] Clear IndexedDB (F12 ‚Üí Application)
- [ ] Click "Sync Now"
- [ ] Verify new products appear
- [ ] Test product details
- [ ] Test search and compare

---

## üêõ Common Mistakes

### Mistake 1: Forgetting to Copy Bundle

```bash
# ‚ùå Wrong - only generates dist/bundle.json.gz
cd mcp-server && node build-bundle-direct.js

# ‚úÖ Right - also copies to myapp/public/
./sync-bundle.sh
```

### Mistake 2: Not Committing Database

```bash
# ‚ùå Wrong - bundle without database
git add myapp/public/bundle.json.gz
git commit -m "Update bundle"

# ‚úÖ Right - bundle AND database
git add myapp/public/bundle.json.gz prisma/dev.db
git commit -m "Update bundle and database"
```

### Mistake 3: Not Clearing Browser Cache

```
‚ùå Deploy ‚Üí Sync ‚Üí Still see old products
‚úÖ Deploy ‚Üí Clear cache ‚Üí Sync ‚Üí See new products
```

### Mistake 4: Using Old MCP Tool

```bash
# ‚ùå Wrong - uses Prisma (may fail)
node mcp-server/build-bundle.js

# ‚úÖ Right - uses better-sqlite3 (always works)
node mcp-server/build-bundle-direct.js
```

---

## üìû Support

If you encounter issues:

1. Check this guide first
2. Check `CLEAR_CACHE_INSTRUCTIONS.md`
3. Verify database: `node check-db.mjs`
4. Check bundle: `gunzip -c myapp/public/bundle.json.gz | jq`
5. Create GitHub issue with error details

---

**Last Updated:** November 5, 2025
**Version:** 1.0
