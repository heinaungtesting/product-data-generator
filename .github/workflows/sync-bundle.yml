name: Auto-sync Bundle

on:
  push:
    paths:
      - 'prisma/dev.db'
      - 'data/products.ndjson'
    branches:
      - 'claude/**'
      - 'main'

jobs:
  sync-bundle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install better-sqlite3 pako
          cd mcp-server && npm install

      - name: Generate bundle from database
        run: |
          cd mcp-server
          node build-bundle-direct.js
          cd ..

      - name: Copy bundle to MyApp
        run: |
          cp dist/bundle.json.gz myapp/public/bundle.json.gz

      - name: Check bundle contents
        run: |
          echo "ðŸ“¦ Bundle contents:"
          gunzip -c myapp/public/bundle.json.gz | node -e "
            const data = JSON.parse(require('fs').readFileSync(0, 'utf-8'));
            console.log('Product count:', data.productCount);
            data.products.forEach(p => {
              const jaText = p.texts.find(t => t.language === 'ja');
              console.log('  -', jaText.name);
            });
          "

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: Auto-sync bundle from database [skip ci]'
          file_pattern: 'myapp/public/bundle.json.gz dist/bundle.json.gz dist/etag.txt data/meta.json'
          commit_user_name: 'GitHub Actions Bot'
          commit_user_email: 'actions@github.com'
          commit_author: 'GitHub Actions <actions@github.com>'
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
          disable_globbing: false
